import ctypes, idc

class ReadPattern:
    def __init__(s, Name, Raw):
        Signature, s.Et, s.Arr = "", 0, Raw.lower().split()
        while s.Et < len(s.Arr) and s.Arr[s.Et] not in dir(s):
            Signature += s.Arr[s.Et] + " "; s.Et += 1
        s.Addr = idc.FindBinary(0, idc.SEARCH_DOWN, Signature)
        while s.Et < len(s.Arr):
            getattr(s, s.Arr[s.Et])(); s.Et += 1
        print("Assoc:", Name, hex(s.Addr))
        idc.MakeName(s.Addr, Name)
    def add(s):
        s.Et += 1; s.Addr += int(s.Arr[s.Et])
    def sub(s):
        s.Et += 1; s.Addr -= int(s.Arr[s.Et])
    def tracerelative(s):
        s.Addr += ctypes.c_int32(idc.Dword(s.Addr)).value + 4
    def tracecall(s):
        s.Addr += 1; s.tracerelative()

# Globals
ReadPattern("LocalActor",
    "48 8b 05 ?? ?? ?? ?? 48 89 6c 24 60 Add 3 TraceRelative")

# Actions
ReadPattern('ActionManager',
        "48 8d 0d ?? ?? ?? ?? 89 44 ?? ?? ?? ff c0 89 44 ?? ?? ?? b9 ?? ?? ?? ?? 89 44 Add 3 TraceRelative")
ReadPattern("RequestAction",
    "?? 53 55 57 ?? 54 ?? 57 ?? 83 ec ?? 83 bc ?? ?? ?? ?? ?? ?? ?? 8b e9 ?? 8b e0 ?? 8b fa ?? 8b f9 ?? 8b d8 74 ?? 80 79 68 ?? 74")
ReadPattern("InteractParam",
    "48 8D 0D ?? ?? ?? ?? 48 83 C4 ?? E9 ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? 48 83 EC ?? 48 8B 0D ?? ?? ?? ?? Add 3 TraceRelative")
ReadPattern("InteractWith",
    "48 89 5C 24 ?? 57 48 83 EC ?? F6 81 ?? ?? ?? ?? ?? 48 8B DA 48 8B F9 0F 85 ?? ?? ?? ?? 48 8B 0D ?? ?? ?? ??")
ReadPattern("IsIconReplaceable",
    "81 f9 2e 01 00 00 7f 39 81 f9")
ReadPattern("GetIcon",
    "E8 ?? ?? ?? ?? F6 DB 8B C8 TraceCall")

# ActorController
ReadPattern("ActorList",
    "48 8D 0D ?? ?? ?? ?? E8 ?? ?? ?? ?? 48 8B D8 48 8B D3 48 8D 0D ?? ?? ?? ?? E8 ?? ?? ?? ?? 48 8D 8E Add 3 TraceRelative")
ReadPattern("TargetPointer",
    "48 83 3D ?? ?? ?? ?? ?? 75 ?? C7 43 Add 3 TraceRelative Add 1")

# Todo: Organize
ReadPattern("SafelyGetUiModule",
    "e8 ?? ?? ?? ?? 48 85 c0 74 3c 48 8b 10 TraceCall")
